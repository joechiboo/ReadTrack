name: ğŸ“š Deploy ReadTrack

on:
  # ç•¶æ¨é€åˆ° main åˆ†æ”¯æ™‚è§¸ç™¼
  push:
    branches: ["main"]

  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

# è¨­å®š GITHUB_TOKEN çš„æ¬Šé™
permissions:
  contents: read
  pages: write
  id-token: write

# åªå…è¨±ä¸€å€‹éƒ¨ç½²åŒæ™‚é‹è¡Œ
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # å»ºç½®å·¥ä½œ
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å–å¾—å®Œæ•´æ­·å²è¨˜éŒ„

      - name: ğŸ“ Display deployment info
        run: |
          echo "==================================="
          echo "ğŸ“š ReadTrack éƒ¨ç½²è³‡è¨Š"
          echo "==================================="

          # å–å¾— commit è¨Šæ¯
          COMMIT_MSG="${{ github.event.head_commit.message }}"

          if [[ "$COMMIT_MSG" == Merge* ]]; then
            # å¦‚æœæ˜¯ PR åˆä½µ
            if [[ "$COMMIT_MSG" =~ "Merge pull request #([0-9]+)" ]]; then
              PR_NUMBER=$(echo "$COMMIT_MSG" | grep -oE '#[0-9]+' | sed 's/#//')
              echo "ğŸ“¦ é¡å‹: Pull Request åˆä½µ"
              echo "ğŸ”¢ PR ç·¨è™Ÿ: #$PR_NUMBER"

              # å˜—è©¦å¾ commit message ä¸­æå– PR æ¨™é¡Œ
              # GitHub çš„åˆä½µè¨Šæ¯æ ¼å¼é€šå¸¸æ˜¯: Merge pull request #X from branch\n\nPRæ¨™é¡Œ
              SECOND_LINE=$(git log -1 --pretty=format:"%B" | sed -n '3p')
              if [ ! -z "$SECOND_LINE" ]; then
                echo "ğŸ“Œ PR æ¨™é¡Œ: $SECOND_LINE"
              fi
            fi
          else
            # ç›´æ¥ commit
            echo "ğŸ“¦ é¡å‹: ç›´æ¥ Commit"
            echo "ğŸ’¬ è¨Šæ¯: $COMMIT_MSG"
          fi

          echo "ğŸ‘¤ ä½œè€…: ${{ github.actor }}"
          echo "ğŸ• æ™‚é–“: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ·ï¸ åˆ†æ”¯: ${{ github.ref_name }}"
          echo "ğŸ”— Commit: ${{ github.sha }}"
          echo "==================================="

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: ğŸ“Š List updated files
        run: |
          echo "ğŸ“Š æœ¬æ¬¡éƒ¨ç½²åŒ…å«çš„æª”æ¡ˆè®Šæ›´ï¼š"
          echo "-----------------------------------"

          # å¦‚æœæ˜¯ merge commitï¼Œé¡¯ç¤º PR ä¸­çš„æ‰€æœ‰è®Šæ›´
          if git rev-parse HEAD^2 >/dev/null 2>&1; then
            git diff --name-status HEAD^1...HEAD^2 | head -20
          else
            # å¦å‰‡é¡¯ç¤ºæœ€å¾Œä¸€æ¬¡ commit çš„è®Šæ›´
            git diff --name-status HEAD~1..HEAD | head -20
          fi

          echo "-----------------------------------"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # ä¸Šå‚³æ•´å€‹å°ˆæ¡ˆç›®éŒ„
          path: '.'

  # éƒ¨ç½²å·¥ä½œ
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: âœ… Deployment completed
        run: |
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸŒ ç¶²ç«™å·²æ›´æ–°: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“š ReadTrack é–±è®€è¿½è¹¤ç³»çµ±å·²ä¸Šç·š"